# Cache开发说明

完整开发过程见https://github.com/SocialistDalao/UltraMIPS_Cache

### 作者

李程浩，哈尔滨工业大学（深圳），2020届龙芯杯UltraMIPS团队队长。

loancold@qq.com

#### 版权说明

所有的Cache代码本人都拥有所有版权，包括文档。本着开源精神，我承诺允许所有的引用和借鉴，但是一定要注明是否进行了借鉴（包括文档与代码）或者直接挪用代码，并且标明来源。

借鉴格式：李程浩-2020龙芯杯UltraMIPS团队-Cache开发说明

挪动（改动）代码格式：李程浩-2020龙芯杯UltraMIPS团队-“代码文件名”

#### Cache简介

全流水二级8KB，二路组相联，伪LRU替换法则。DCache对写采用Write-Back与Write-Allocate策略。

#### Cache前置说明

整个Cache主体文档为Cache_Design.md，该文件并非描述一个主体的结构，而是记录了开发的总过程，以此我们试图构造一个比较细致的开发指导。因为Cache的开发参考较少，但是Cache对于性能提升比较关键，因此我以这种方式来给读者提供便利，加速Cache的开发过程。

同时，我们的Cache也出现了非常多的问题，其中最可怕的有两种

- 时序问题：处理数据时数据变化、送出数据没有同步（数据有非常多种，每一种都要满足）
- DCache写操作：写出错是没有办法立刻定位的，需要判断读出的数据错误才能够定位。同时因为写进去的数据要不藏在Cache内部要不已经被写进了主存，因此都要定位。

好了说了这么多，我们可以开始进入正轨了，下面我们来叙述一些阅读正文的方法吧。

#### 文件包阅读说明

##### 代码

代码的阅读非常耗时，还好我贴心为你准备了一些架构的说明。这些说明藏在文档Cache_Design.md中，但是正如之前所说，它是按照时间顺序逐渐说明的，逐步完善的，但是在其中我们还是给出了接口的说明，以此我们可以总览全貌。

不仅如此，在代码中首行我们也加入了相关的注释说明，以表现出代码的清晰架构，方便理解整个代码开发是如何进行的。

需要提出一点的是，由于乱码原因，作者之前的中文注释很多都被去除了，因此虽然在之后补充了英文注释，但是可能没有办法再次达到整个之前的注释量，对此我感到抱歉，但是我有自信，该代码的注释量在同类代码中算密集的，文档也是。

由于开发并不完全遵守规范，换句话说就是时间不允许，我们代码的命名和结构在少部分情况下违背了惯例，希望在遇到类似的情况需要加以注意。非常抱歉！

##### 文档

Cache的专属文档作用在于加速开发进程，进行解惑。在开发初期，我们可以通读整个开发的进程，了解作者开发的顺序，但是之后在正式的开发时，我们可以仅仅盯住对应步骤的文段，进行分析研究，以获取灵感和寻找方向。

##### 整个项目文档

同时考虑到还会遇见仅仅想要进行参考的读者，我对此也有相应的应对措施。在主目录，我们放入了整个项目的报告report.pdf，在其中，我们以最终完整版的形式用六页左右的篇幅介绍Cache，包括了应有的构造以及突出的细节。

##### FullSrc

这里面记录着整个Cache开发过程的代码文件，为了使得读者能够尽可能理解其中的含义，我们做一些解释。

- DCache_pipeline：该文件不是流水线cache，而是适应ex访存mem出的时序的DCache，真正的文件在DCache_ReadPipeline
- bpu：加入动态取指的版本
- lutram：将tag ram用lut ram（distributed RAM）来构造
- single_WB：将writebuffer简化为队列大小为1
- TLB：虚假的TLB，只简单的做地址的线性虚实转换以及uncached判定。
- defines_cache：cache专有宏定义

#### 最后

谢谢大家噢！给个star。

#### 联系作者

如有文档错误、代码错误、新的想法、项目合作、工作邀请、学术探讨、更好的cache设计等等，可以邮箱方式联系本人。

loancold@qq.com

